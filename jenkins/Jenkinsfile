/*
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *  Jenkins Declarative Pipeline â€“ MERN BuildÂ +Â PushÂ +Â HelmÂ Deploy to Minikube
 * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 *
 *  Prereqs on the Jenkins controller/agent:
 *  â–¸ Docker CLI & daemon
 *  â–¸ Helm v3.x
 *  â–¸ kubectl (pointing to Minikube once KUBECONFIG is exported)
 *
 *  Credentials required in Jenkins:
 *  â–¸ â€œDOCKERHUB_CREDSâ€  â€“ username / password for Docker Hub
 *  â–¸ â€œK8S_MINIKUBEâ€     â€“ Secretâ€‘File (the flattened kubeconfig you generated)
 *    (Manage Jenkins â–¸ Credentials â–¸ kind: â€œSecret fileâ€)
 */

pipeline {
    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ AGENT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    agent any

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ GLOBAL ENV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    environment {
        IMAGE_TAG = "v${BUILD_NUMBER}"          // e.g. v23
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ STAGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    stages {

        /* â”€â”€â”€â”€â”€ Build & Push BACKEND Docker image â”€â”€â”€â”€â”€ */
        stage('Build & Push Backend Image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'DOCKERHUB_CREDS',
                    usernameVariable: 'DOCKERHUB_USER',
                    passwordVariable: 'DOCKERHUB_PASS'
                )]) {

                    script {
                        docker.withRegistry('https://index.docker.io/v1/', 'DOCKERHUB_CREDS') {

                            def backendImg = docker.build(
                                "${DOCKERHUB_USER}/mern-backend:${IMAGE_TAG}",
                                "-f ${env.WORKSPACE}/backend/Dockerfile ${env.WORKSPACE}/backend"
                            )

                            backendImg.push()
                        }
                    }
                }
            }
        }

        /* â”€â”€â”€â”€â”€ Build & Push FRONTEND Docker image â”€â”€â”€â”€â”€ */
        stage('Build & Push Frontend Image') {
            steps {
                withCredentials([usernamePassword(
                    credentialsId: 'DOCKERHUB_CREDS',
                    usernameVariable: 'DOCKERHUB_USER',
                    passwordVariable: 'DOCKERHUB_PASS'
                )]) {

                    script {
                        docker.withRegistry('https://index.docker.io/v1/', 'DOCKERHUB_CREDS') {

                            def frontendImg = docker.build(
                                "${DOCKERHUB_USER}/mern-frontend:${IMAGE_TAG}",
                                "-f ${env.WORKSPACE}/frontend/Dockerfile ${env.WORKSPACE}/frontend"
                            )

                            frontendImg.push()
                        }
                    }
                }
            }
        }

        /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Deploy to Minikube via Helm â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        stage('Deploy to Minikube using Helm') {
            steps {
                withCredentials([
                    file(credentialsId: 'K8S_MINIKUBE', variable: 'KCFG'),
                    usernamePassword(
                        credentialsId: 'DOCKERHUB_CREDS',
                        usernameVariable: 'DOCKERHUB_USER',
                        passwordVariable: 'DOCKERHUB_PASS'
                    )
                ]) {

                    sh """
                        # Export kubeâ€‘context for Helm / kubectl
                        export KUBECONFIG="${KCFG}"

                        # Always run Helm from the chart root
                        cd ${WORKSPACE}/helm-chart/mern-chart

                        # Install or upgrade the release with precise image keys
                        helm upgrade --install mern-release . \
                          --set backend.image.repository=${DOCKERHUB_USER}/mern-backend \
                          --set backend.image.tag=${IMAGE_TAG} \
                          --set frontend.image.repository=${DOCKERHUB_USER}/mern-frontend \
                          --set frontend.image.tag=${IMAGE_TAG}
                    """
                }
            }
        }
    }

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ POST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    post {
        success {
            echo 'ğŸ‰ Deployment successful!'
        }
        failure {
            echo 'âŒ Build or deploy failed'
        }
    }
}
